<!DOCTYPE html>
<html>
  <head>
    <title>Timetable Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      table {
        width: 80%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
      }
      th {
        background: lightblue;
      }
      .batch-title {
        font-weight: bold;
        font-size: 20px;
        margin-top: 30px;
      }
      .highlight {
        background-color: yellow;
        font-weight: bold;
        padding: 2px 4px;
        border-radius: 4px;
      }
      .error {
        color: red;
        font-weight: bold;
        font-size: 18px;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <h2>Upload CSV File</h2>
    <input type="file" id="csvFile" accept=".csv" />

    <h3>Faculty-wise Timetable</h3>
    <select id="facultySelect">
      <option value="">-- All Batches (Default) --</option>
    </select>
    <button onclick="handleView()">View</button>

    <div id="tables"></div>

    <script>
      let originalData = [];

      document
        .getElementById("csvFile")
        .addEventListener("change", function () {
          Papa.parse(this.files[0], {
            header: true,
            skipEmptyLines: true,
            complete: function (result) {
              originalData = result.data;

              const clashMsg = detectOverlaps(originalData);
              if (clashMsg) {
                document.getElementById(
                  "tables"
                ).innerHTML = `<div class="error">‚ùå CSV ERROR: ${clashMsg}</div>`;
                return;
              }

              populateFacultyDropdown(originalData);
              processBatchWise(originalData);
            },
          });
        });

      /* -------------------- OVERLAP DETECTION -------------------- */

      function detectOverlaps(data) {
        const batchSlots = {};
        const facultySlots = {};

        for (const row of data) {
          const day = row["DAY"];
          const session = row["SESSION"];
          const batch = row["BATCH"];
          const faculty = row["FACULTY"];

          if (!day || !session) continue;

          const slotKey = `${day}-${session}`;

          // Batch overlap check
          batchSlots[batch] ??= {};
          if (batchSlots[batch][slotKey]) {
            return `Batch "${batch}" has overlapping classes on ${day} (${session})`;
          }
          batchSlots[batch][slotKey] = true;

          // Faculty overlap check
          facultySlots[faculty] ??= {};
          if (facultySlots[faculty][slotKey]) {
            return `Faculty "${faculty}" has overlapping classes on ${day} (${session})`;
          }
          facultySlots[faculty][slotKey] = true;
        }
        return null;
      }

      /* -------------------- FACULTY DROPDOWN -------------------- */

      function populateFacultyDropdown(data) {
        const facultySet = new Set();
        const select = document.getElementById("facultySelect");
        select.innerHTML = `<option value="">-- All Batches (Default) --</option>`;

        data.forEach((row) => {
          if (row["FACULTY"]) facultySet.add(row["FACULTY"].trim());
        });

        facultySet.forEach((faculty) => {
          const option = document.createElement("option");
          option.value = faculty;
          option.textContent = faculty;
          select.appendChild(option);
        });
      }

      function handleView() {
        const faculty = document.getElementById("facultySelect").value;
        if (faculty === "") {
          processBatchWise(originalData);
        } else {
          showFacultyTimetable(faculty);
        }
      }

      /* -------------------- BATCH-WISE VIEW -------------------- */

      function processBatchWise(data) {
        const timetable = {};

        data.forEach((row) => {
          const batch = row["BATCH"];
          const day = row["DAY"];
          const session = row["SESSION"];
          const course = row["COURSE"];
          const room = row["ROOM"];
          const faculty = row["FACULTY"];

          if (!batch || !day || !session) return;

          timetable[batch] ??= {};
          timetable[batch][day] ??= { FN: "", AN: "" };

          const courseText =
            batch === "VI-SU-B2"
              ? `<span class="highlight">${course}</span>`
              : course;

          timetable[batch][day][
            session
          ] = `${courseText}<br>Room: ${room}<br>Faculty: ${faculty}`;
        });

        buildBatchTables(timetable);
      }

      function buildBatchTables(timetable) {
        const container = document.getElementById("tables");
        container.innerHTML = "";

        const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];

        for (const batch in timetable) {
          const title = document.createElement("div");
          title.className = "batch-title";
          title.innerText = `Batch: ${batch}`;

          const table = document.createElement("table");

          let html =
            "<tr><th>DAY</th><th>FN</th><th rowspan='7'>L<br>U<br>N<br>C<br>H</th><th>AN</th></tr>";

          days.forEach((day) => {
            html += `
              <tr>
                <td>${day}</td>
                <td>${timetable[batch][day]?.FN || ""}</td>
                <td>${timetable[batch][day]?.AN || ""}</td>
              </tr>
            `;
          });

          table.innerHTML = html;
          container.appendChild(title);
          container.appendChild(table);
        }
      }

      /* -------------------- FACULTY-WISE SINGLE TABLE -------------------- */

      function showFacultyTimetable(faculty) {
        const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];
        const timetable = {};
        days.forEach((d) => (timetable[d] = { FN: [], AN: [] }));

        originalData.forEach((row) => {
          if (row["FACULTY"]?.trim() === faculty) {
            const batchText =
              row["BATCH"] === "VI-SU-B2"
                ? `<span class="highlight">${row["BATCH"]}</span>`
                : row["BATCH"];

            timetable[row["DAY"]][row["SESSION"]].push(
              `${batchText} (${row["COURSE"]})`
            );
          }
        });

        buildFacultyTable(faculty, timetable);
      }

      function buildFacultyTable(faculty, timetable) {
        const container = document.getElementById("tables");
        container.innerHTML = "";

        const title = document.createElement("h3");
        title.innerText = `Faculty Timetable: ${faculty}`;

        const table = document.createElement("table");

        let html = `
          <tr>
            <th>DAY</th>
            <th>FN</th>
            <th rowspan="7">L<br>U<br>N<br>C<br>H</th>
            <th>AN</th>
          </tr>
        `;

        for (const day in timetable) {
          html += `
            <tr>
              <td>${day}</td>
              <td>${timetable[day].FN.join("<br>")}</td>
              <td>${timetable[day].AN.join("<br>")}</td>
            </tr>
          `;
        }

        table.innerHTML = html;
        container.appendChild(title);
        container.appendChild(table);
      }
    </script>
  </body>
</html>
