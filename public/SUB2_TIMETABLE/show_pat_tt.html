<!DOCTYPE html>
<html>
  <head>
    <title>Batch-wise Timetable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
      table {
        width: 80%;
        border-collapse: collapse;
        margin: 20px 0;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
      }
      th {
        background: lightblue;
      }
      .batch-title {
        font-weight: bold;
        font-size: 20px;
        margin-top: 30px;
      }
    </style>
  </head>

  <body>
    <h2>Upload CSV File</h2>
    <input type="file" id="csvFile" accept=".csv" />

    <!-- Faculty Dropdown -->
    <h3>View Faculty Timetable</h3>
    <select id="facultySelect">
      <option value="">-- Select Faculty --</option>
    </select>
    <button onclick="filterByFaculty()">Show Faculty Timetable</button>

    <div id="tables"></div>

    <script>
      let originalData = [];

      document
        .getElementById("csvFile")
        .addEventListener("change", function () {
          Papa.parse(this.files[0], {
            header: true,
            skipEmptyLines: true,
            complete: function (result) {
              originalData = result.data;
              populateFacultyDropdown(result.data);
              processCSV(result.data); // show full timetable initially
            },
          });
        });

      function populateFacultyDropdown(data) {
        const facultySet = new Set();
        const select = document.getElementById("facultySelect");
        select.innerHTML = `<option value="">-- Select Faculty --</option>`;

        data.forEach((row) => {
          if (row["FACULTY"]) {
            facultySet.add(row["FACULTY"].trim());
          }
        });

        facultySet.forEach((faculty) => {
          const option = document.createElement("option");
          option.value = faculty;
          option.textContent = faculty;
          select.appendChild(option);
        });
      }

      function processCSV(data) {
        const timetable = {};

        data.forEach((row) => {
          const batch = row["BATCH"];
          const day = row["DAY"];
          const session = row["SESSION"]; // FN / AN
          const course = row["COURSE"];
          const room = row["ROOM"];
          const faculty = row["FACULTY"];

          if (!batch || !day || !session) return;

          if (!timetable[batch]) {
            timetable[batch] = {};
          }
          if (!timetable[batch][day]) {
            timetable[batch][day] = { FN: "", AN: "" };
          }

          timetable[batch][day][
            session
          ] = `${course}<br>Room: ${room}<br>Faculty: ${faculty}`;
        });

        buildTables(timetable);
      }

      function buildTables(timetable) {
        const container = document.getElementById("tables");
        container.innerHTML = "";

        const days = ["MON", "TUE", "WED", "THU", "FRI", "SAT"];

        for (const batch in timetable) {
          const wrapper = document.createElement("div");
          wrapper.style.marginBottom = "40px";

          const title = document.createElement("div");
          title.className = "batch-title";
          title.innerHTML = `Batch: ${batch}`;

          const table = document.createElement("table");

          let html =
            "<tr><th>DAY</th><th>FN</th><th rowspan=7>L<br>U<br>N<br>C<br>H</th><th>AN</th></tr>";

          days.forEach((day) => {
            const fn = timetable[batch][day]?.FN || "";
            const an = timetable[batch][day]?.AN || "";
            html += `
              <tr>
                <td>${day}</td>
                <td>${fn}</td>
                <td>${an}</td>
              </tr>
            `;
          });

          table.innerHTML = html;

          wrapper.appendChild(title);
          wrapper.appendChild(table);
          container.appendChild(wrapper);
        }
      }

      function filterByFaculty() {
        const faculty = document.getElementById("facultySelect").value;

        if (!faculty) {
          alert("Please select a Faculty");
          return;
        }

        const filteredData = originalData.filter(
          (row) => row["FACULTY"] && row["FACULTY"].trim() === faculty
        );

        processCSV(filteredData);
      }
    </script>
  </body>
</html>
